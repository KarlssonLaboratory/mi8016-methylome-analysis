---
title: "Analysis of Variance - ANOVA"
subtitle: "Comparison of multiple group means"

toc: true
toc-depth: 3        						# heading levels to include (default is 3)
toc-location: left  						# "left", "right" (default), or "body"
toc-title: "Contents"
---

In the [PFOS paper from 2018](https://doi.org/10.1007/s00204-017-2077-8), PFOS in different doses and exposure times was applied and correlated with phenotypes such as proliferation, invation and migration. Here, we will reproduce the statistics and the figures for [figure 1F](https://link.springer.com/article/10.1007/s00204-017-2077-8/figures/1) and [figure 3](https://link.springer.com/article/10.1007/s00204-017-2077-8/figures/3). 

```{r}
# Once per machine
#install.packages("forcats") 	# <1>

# Every R session
library(forcats) 							# <2>
```

1. Install packages with `install.packages("<package-name>")`, use quotes
2. Load library with `library(<package-name>)`

## Make plots in R

Figure 1F shows the proliferation phenotype over mulitple doses of PFOS. Proliferation is translated into how the cells are dividing by observing number of cell nuclei with a staining method called [DAPI](https://en.wikipedia.org/wiki/DAPI).

Import the dataset, will be contained inside a "data frame", and inspect it with the `head()` and `summary()` functions:

```{r}
# Import dataset
dat <- read.csv("../data/proliferation.csv") 				# <1>

#rows <- !is.na(dat$value)
#dat <- dat[rows,]

# head shows the top 6 rows of a data frame
head(dat)

# summary shows ranges and types per column
summary(dat)
```

1. This path is relative to where you start your R session. If you start inside `docs/` use `"../data/proliferation.csv"`, if you start inside the project folder use `"data/proliferation.csv"`.

::: {.callout-tip collapse=true title="What can you read about the dataset?"}
The data frame is composed:

+ 2 columns : variables and value
+ 52 rows 	: all numeric with 2 NAs 
:::

Lets make a simple plot! 

The `plot()` function can read a data frame and recognice that the variable column is categorical and the value column is numeric. With this a box-plot figure is built where `x = variable` and `y = value`:

```{r}
# Make variable column into factor (categorical)
dat$variable <- fct_inorder(dat$variable)         # <1>

# Plot time!
plot(dat)
```

1. `forcats::fct_inorder` makes the categorices of the column the order they appear.

The plot function also takes in additional _arguments_, like `main`, `ylab` and `xlab`.

```{r}
# main = title
# ylab = text on y-axis
# xlab = text on x-asis
plot(dat, main = "Proliferation", ylab = "DAPI Positive cells", xlab = "")
```

::: {.callout-tip collapse=true title="Function arguments"}

All functions in R comes with documentation, where the function and all the arguments the function takes in are described. To open the documentation use the question mark `?` before the name of the function, like `?plot` will show:

```yml
plot                   package:base                    R Documentation

Generic X-Y Plotting

Description:

     Generic function for plotting of R objects.

     For simple scatter plots, ‘plot.default’ will be used.  However,
     there are ‘plot’ methods for many R objects, including
     ‘function’s, ‘data.frame’s, ‘density’ objects, etc.  Use
     ‘methods(plot)’ and the documentation for these. Most of these
     methods are implemented using traditional graphics (the ‘graphics’
     package), but this is not mandatory.
```

To exit the documentation, press `q`.

:::

R comes with many packages to help customise plots. [`ggplot2`](https://ggplot2.tidyverse.org/) is the most popular one and builts on "layers" of geometic objects, called `geom`. The dataset is loaded via the `ggplot()` function and mapped via aesthetics (`aes`). Aesthetics contols x, y, outline colors, inside fill colors, sizes, shapes etc.

Lets style the plot with `ggplot2`! Run the code below:

```{r}
# Ones per machine
#install.packages("ggplot2")

# Every R sessoin
library(ggplot2)

ggplot(dat, aes(x = variable, y = value, fill = variable)) + 	# <1>
  geom_bar(fun = "mean", stat = "summary", color = "black") + # <2>
  theme_classic(base_size = 18) + 														# <3>
  labs( 																											# <4>
    title = "Proliferation",
    x = "",
    y = "DAPI Positive cells")
```

1. By adding a plus sign `+` multiple rows are chained fo the plot
2. `geom_bar()` uses the mean to calculate the top part of the bar
3. `theme_classic()` is on of many themes for decorating a plot. `base_size` sets the overall size.
4. `labs()` holds arguments for text inputs for title, x-axis, y-axis, etc

The legend is not needed, remove it with `theme(legend.position = "none")`:

```{r}
ggplot(dat, aes(x = variable, y = value, fill = variable)) +
  geom_bar(fun = "mean", stat = "summary", color = "black") +
  theme_classic(base_size = 18) +
  theme(legend.position = "none") + 														# <1>
  labs(
    title = "Proliferation",
    x = "",
    y = "DAPI Positive cells")
```

1. legend.position is set to "none" and therefor not rendered. Default value is: legend.position = "right"

We need to add "whiskers" to the plot, which shows mean +/- standard deviation, i.e the variance. Use `geom_errorbar`: 

```{r}
ggplot(dat, aes(x = variable, y = value, fill = variable)) +
  geom_bar(fun = "mean", stat = "summary", color = "black") +
  geom_errorbar(
  	stat = "summary",
    fun.min = function(x) mean(x) - sd(x),  # <1>
    fun.max = function(x) mean(x) + sd(x),  # <2>
    width = 0.4) +                          # <3> 
  theme_classic(base_size = 18) +
  theme(legend.position = "none") +
  labs(
    title = "Proliferation",
    x = "",
    y = "DAPI Positive cells")
```

1. Bottom whisker
2. Top whisker
3. Width of whiskars

Tilt the x-axis text 45 degress. `theme` holds all arguments for the plots general appearence:

::: {.callout-tip collapse=true title="theme documentation"}
Check the doumentation: `?theme`

Close with `q`.
:::

```{r}
ggplot(dat, aes(x = variable, y = value, fill = variable)) +
  geom_bar(fun = "mean", stat = "summary", color = "black") +
  geom_errorbar(
  	stat = "summary",
    fun.min = function(x) mean(x) - sd(x),
    fun.max = function(x) mean(x) + sd(x),
    width = 0.4) + 
  theme_classic(base_size = 18) +
  theme(
  	legend.position = "none",
  	axis.text.x = element_text(angle = 45, hjust = 1)) + 				# <1>
  labs(
    title = "Proliferation",
    x = "",
    y = "DAPI Positive cells")
```

1. `hjust = 1` aligns the text to right-justifed.

## Exercise

The colors of the actual figure does not match our colors. Can you match the colors? Here is the original [figure 1F](https://link.springer.com/article/10.1007/s00204-017-2077-8/figures/1).

::: {.callout-tip collapse=true title="Hint 1"}

The attribute to alter is `fill` since these colors are inside the bars

:::

::: {.callout-tip collapse=true title="Hint 2"}

Use the `scale_fill_manual()` layer. Get more info of which arguments the layer takes with `?scale_fill_manual`.

:::

::: {.callout-tip collapse=true title="Hint 3"}

Check the internet! [stackoverflow.com](https://stackoverflow.com/search?q=scale+fill+custom+colors+R) is a platform which LLM's are trained on.

:::

## Statistics

Lets compare the group means of the different doses to see if there is any significant differences! An Analysis of Variance (ANOVA) analysis will tells us if there is a difference between the tested groups, but not between which. For this we run a _post-hoc_ (lat. after this) test. The Tukey-Kramer test is post-hoc test that will tell us between which groups there is a difference.

The `aov()` function runs an ANOVA analysis. The formula argument reads `y ~ x`, hence we use `value ~ variabale`. The `summary()` function will show us the overall result of the ANOVA:

```{r}
model <- aov(formula = value ~ variable, data = dat)

summary(model)
```

The `Pr(>F)` column holds the _p_-values. Here we can see that the model is significant. Lets found out between which groups. For this, run `TukeyHSD()` (Tukey Honest Significant Differences) test, with the model as argument. Print the results after:

```{r}
results <- TukeyHSD(model)

results
```

We see all the comparisons now. We are only interested in the comparisons with `Control`. Instead of doing this manually lets extract those comparisons computationally. 

`results` is an object. We want the data frame with comparisons only. This is found in `results$variable`:

```{r}
results$variable
```

The comparisons are not in a column but in the row names:

```{r}
rownames(results$variable)
```

`grep()` is a function that will match a string, lets use `"Control"` as the string. This will return which rows are matches:

```{r}
rows <- grep("Control", rownames(results$variable))
rows
```

Now lets only select those rows:

```{r}
data <- results$variable[rows, ]
```

Make the object into a `data.frame()`

```{r}
data <- data.frame(data)
```

Check the results!

```{r}
data
```

Lastly, lets only focus only on the significant ones. `subset()` filters columns based on criterias:

```{r}
subset(data, p.adj < 0.05)
```

Does our results match figure 1F of the paper??

::: {.callout-note collapse=true}

## Resources

+ [The Tukey test](https://r-graph-gallery.com/84-tukey-test.html)
+ [ANOVA and Tukey Kramer posthoc test](https://scibrief.blog/tukey-kramer-r)

:::